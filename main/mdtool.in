#!/bin/sh

#this script should be in $PREFIX/bin
PREFIX="${0%%/mdtool}/.."

MD_FORCE_DEBUG=yes

### SYNCH BLOCK: any changes to this block should be kept in sync with the one in Makefile.include and monodevelop.in
MONO_PREFIX=`which mono`
MONO_PREFIX="${MONO_PREFIX%%/mono}/.."
PKGCONFIG_PREFIX=`which pkg-config`
PKGCONFIG_PREFIX="${PKGCONFIG_PREFIX%%/pkg-config}/.."

MD_PKG_CONFIG_PATH=""
for D in "$PREFIX/.." "$MONO_PREFIX" "$PKGCONFIG_PREFIX" '/usr/local' '/usr'; do
	for PKGDIR in "$D/../lib/pkgconfig" "$D/../lib64/pkgconfig" "$D/../share/pkgconfig"; do
		if [ -d "$PKGDIR" ]; then MD_PKG_CONFIG_PATH="$MD_PKG_CONFIG_PATH:$PKGDIR"; fi
	done
done
### END BLOCK

if [ -n $PKG_CONFIG_PATH ]; then
	export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$MD_PKG_CONFIG_PATH
else
	export PKG_CONFIG_PATH=$MD_PKG_CONFIG_PATH
fi

ARGS=""

for arg in $*; do 
case x$arg in
	x--profile*)
		MONO_OPTIONS="$MONO_OPTIONS $arg"
		shift
		;;
	x--debug*)
		export MONODEVELOP_DISPATCH_DEBUG=yes
		unset MD_FORCE_DEBUG
		MONO_OPTIONS="$MONO_OPTIONS $arg"
		shift
		;;
	x--trace*)
		MONO_OPTIONS="$MONO_OPTIONS $arg"
		shift
		;;
	x--no-debug)
		unset MD_FORCE_DEBUG
		shift
		;;
	*)
		ARGS="$ARGS $arg"
		shift
		;;
esac		
done

if [ -z MD_FORCE_DEBUG ]; then
	MONO_OPTIONS="$MONO_OPTIONS --debug"
fi

if [ -n "$MONO_OPTIONS" ]; then
	echo "** Running with Mono options: $MONO_OPTIONS **"
fi

exec_args="-a mdtool mono $MONO_OPTIONS $PREFIX/lib/monodevelop/bin/mdrun.exe $ARGS"

exec $exec_args

